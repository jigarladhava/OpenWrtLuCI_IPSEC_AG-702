#!/bin/sh
#
# UCI Defaults for IPsec VPN Package
# Runs once on first installation
#

# Initialize UCI config if it doesn't exist
if [ ! -f /etc/config/ipsec ]; then
	touch /etc/config/ipsec
fi

# Ensure scripts are executable
chmod +x /usr/sbin/ipsec-route.sh 2>/dev/null
chmod +x /usr/sbin/ipsec-monitor.sh 2>/dev/null

# Add startup commands to rc.local if not present
if [ -f /etc/rc.local ]; then
	# Remove any existing IPsec entries
	sed -i '/ipsec-route.sh/d' /etc/rc.local
	sed -i '/IPsec VPN/d' /etc/rc.local
	sed -i '/VPN route configured/d' /etc/rc.local
	sed -i '/^exit 0/d' /etc/rc.local

	# Add our startup commands
	cat >> /etc/rc.local << 'EOF'

# IPsec VPN - Add route after boot
(
  sleep 20
  /usr/sbin/ipsec-route.sh
  logger -t ipsec "VPN route configured on boot"
) &

exit 0
EOF
fi

# Enable IP forwarding
if ! grep -q "net.ipv4.ip_forward=1" /etc/sysctl.conf 2>/dev/null; then
	echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
fi
sysctl -w net.ipv4.ip_forward=1 2>/dev/null

# Create log directory
mkdir -p /var/log/ipsec 2>/dev/null

# Set permissions
chmod 600 /etc/ipsec.secrets 2>/dev/null

# Add cron job for IPsec monitoring (if not already present)
if [ -f /etc/crontabs/root ]; then
	if ! grep -q "ipsec-monitor.sh" /etc/crontabs/root; then
		echo "*/3 * * * * /usr/sbin/ipsec-monitor.sh" >> /etc/crontabs/root
		/etc/init.d/cron restart 2>/dev/null
		logger -t ipsec "IPsec monitoring cron job installed"
	fi
else
	# Create crontab file if it doesn't exist
	mkdir -p /etc/crontabs
	echo "*/3 * * * * /usr/sbin/ipsec-monitor.sh" > /etc/crontabs/root
	/etc/init.d/cron restart 2>/dev/null
	logger -t ipsec "IPsec monitoring cron job installed"
fi

# Make ping monitor script executable
chmod +x /usr/sbin/ipsec-ping-monitor.sh 2>/dev/null
chmod +x /etc/init.d/ipsec-ping-monitor 2>/dev/null

# Enable ping monitor init script (but don't start unless config enabled)
/etc/init.d/ipsec-ping-monitor enable 2>/dev/null

exit 0
